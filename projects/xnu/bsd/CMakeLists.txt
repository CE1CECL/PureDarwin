add_subdirectory(conf)

add_subdirectory(bsm)
add_subdirectory(crypto)
add_subdirectory(dev)
add_subdirectory(i386)
add_subdirectory(libkern)
add_subdirectory(machine)
add_subdirectory(man)
add_subdirectory(miscfs)
add_subdirectory(net)
add_subdirectory(netinet)
add_subdirectory(netinet6)
add_subdirectory(netkey)
add_subdirectory(nfs)
add_subdirectory(pthread)
add_subdirectory(security/audit)
add_subdirectory(sys)
add_subdirectory(sys_private)
add_subdirectory(uuid)
add_subdirectory(vfs)
add_subdirectory(vm)

add_darwin_object_library(xnu.bsd_module)
target_sources(xnu.bsd_module PRIVATE
    # This list was generated from the Makefile output in the conf/ subdirectory.
    # Unfortunately, in CMake all sources must be known at configuration time.
    # Therefore, if the config inputs change, we will need to update this manually.
    # Look for the $(CFILES) variable definition in the Makefile.
    nfs/nfs4_subs.c
    nfs/nfs4_vnops.c
    nfs/krpc_subr.c
    nfs/nfs_bio.c
    nfs/nfs_boot.c
    nfs/nfs_gss.c
    nfs/nfs_lock.c
    nfs/nfs_node.c
    nfs/nfs_serv.c
    nfs/nfs_socket.c
    nfs/nfs_srvcache.c
    nfs/nfs_subs.c
    nfs/nfs_syscalls.c
    nfs/nfs_vfsops.c
    nfs/nfs_vnops.c
    nfs/nfs_upcall.c
    nfs/gss/gss_krb5_mech.c
    nfs/gss/ccrypto.c
    kern/netboot.c
    dev/dtrace/dtrace.c
    dev/dtrace/lockprof.c
    dev/dtrace/lockstat.c
    dev/dtrace/dtrace_ptss.c
    dev/dtrace/dtrace_subr.c
    dev/dtrace/dtrace_glue.c
    dev/dtrace/dtrace_xoroshiro128_plus.c
    dev/dtrace/blist.c
    dev/dtrace/fbt.c
    dev/dtrace/fbt_blacklist.c
    dev/dtrace/sdt.c
    dev/dtrace/sdt_subr.c
    dev/dtrace/systrace.c
    dev/dtrace/profile_prvd.c
    dev/dtrace/fasttrap.c
    dev/random/randomdev.c
    dev/memdev.c
    dev/mem.c
    dev/munge.c
    dev/unix_startup.c
    libkern/crc16.c
    libkern/crc32.c
    libkern/random.c
    libkern/scanc.c
    libkern/strsep.c
    libkern/bcd.c
    libkern/memchr.c
    libkern/url_encode.c
    vfs/vfs_attrlist.c
    vfs/vfs_bio.c
    vfs/vfs_cache.c
    vfs/vfs_cluster.c
    vfs/vfs_conf.c
    vfs/vfs_fslog.c
    vfs/vfs_init.c
    vfs/vfs_lookup.c
    vfs/vfs_quota.c
    vfs/vfs_subr.c
    vfs/vfs_syscalls.c
    vfs/vfs_support.c
    vfs/vfs_utfconv.c
    vfs/vfs_unicode.c
    vfs/vfs_vnops.c
    vfs/vfs_xattr.c
    vfs/vnode_if.c
    vfs/kpi_vfs.c
    vfs/vfs_fsevents.c
    vfs/vfs_cprotect.c
    vfs/doc_tombstone.c
    vfs/vfs_disk_conditioner.c
    miscfs/deadfs/dead_vnops.c
    miscfs/devfs/devfs_fdesc_support.c
    miscfs/fifofs/fifo_vnops.c
    miscfs/specfs/spec_vnops.c
    miscfs/devfs/devfs_tree.c
    miscfs/devfs/devfs_vnops.c
    miscfs/devfs/devfs_vfsops.c
    kern/decmpfs.c
    net/net_stubs.c
    net/bpf.c
    net/bpf_filter.c
    net/if_bridge.c
    net/if.c
    net/init.c
    net/dlil.c
    net/ether_if_module.c
    net/ether_inet_pr_module.c
    net/ether_inet6_pr_module.c
    net/if_loop.c
    net/if_mib.c
    net/if_vlan.c
    net/if_fake.c
    net/if_6lowpan.c
    net/multicast_list.c
    net/if_bond.c
    net/devtimer.c
    net/ndrv.c
    net/radix.c
    net/raw_cb.c
    net/raw_usrreq.c
    net/route.c
    net/rtsock.c
    net/netsrc.c
    net/ntstat.c
    net/net_perf.c
    net/if_gif.c
    net/if_stf.c
    net/if_ports_used.c
    net/if_low_power_mode.c
    net/kpi_interface.c
    net/kpi_protocol.c
    net/kpi_interfacefilter.c
    net/net_str_id.c
    net/if_utun.c
    net/if_ipsec.c
    net/necp.c
    net/necp_client.c
    net/network_agent.c
    net/if_pflog.c
    net/nat464_utils.c
    net/pf.c
    net/pf_if.c
    net/pf_ioctl.c
    net/pf_norm.c
    net/pf_osfp.c
    net/pf_pbuf.c
    net/pf_ruleset.c
    net/pf_table.c
    net/iptap.c
    net/pktap.c
    net/if_llreach.c
    net/flowhash.c
    net/flowadv.c
    net/content_filter.c
    net/content_filter_crypto.c
    net/if_llatbl.c
    net/nwk_wq.c
    net/restricted_in_port.c
    net/classq/classq.c
    net/classq/classq_sfb.c
    net/classq/classq_subr.c
    net/classq/classq_util.c
    net/classq/classq_fq_codel.c
    net/pktsched/pktsched.c
    net/pktsched/pktsched_fq_codel.c
    net/pktsched/pktsched_netem.c
    netinet/cpu_in_cksum_gen.c
    netinet/in_cksum.c
    netinet/igmp.c
    netinet/in.c
    netinet/dhcp_options.c
    netinet/in_arp.c
    netinet/in_mcast.c
    netinet/in_pcb.c
    netinet/in_pcblist.c
    netinet/in_proto.c
    netinet/in_rmx.c
    netinet/in_stat.c
    netinet/in_tclass.c
    netinet/ip_dummynet.c
    netinet/ip_icmp.c
    netinet/ip_id.c
    netinet/ip_input.c
    netinet/ip_output.c
    netinet/raw_ip.c
    netinet/tcp_cache.c
    netinet/tcp_input.c
    netinet/tcp_output.c
    netinet/tcp_sack.c
    netinet/tcp_subr.c
    netinet/tcp_timer.c
    netinet/tcp_usrreq.c
    netinet/tcp_cc.c
    netinet/tcp_newreno.c
    netinet/tcp_cubic.c
    netinet/cbrtf.c
    netinet/tcp_ledbat.c
    netinet/tcp_log.c
    netinet/udp_usrreq.c
    netinet/in_gif.c
    netinet/ip_ecn.c
    netinet/ip_encap.c
    netinet/kpi_ipfilter.c
    netinet/flow_divert.c
    netinet/mp_proto.c
    netinet/mp_pcb.c
    netinet/mptcp.c
    netinet/mptcp_subr.c
    netinet/mptcp_usrreq.c
    netinet/mptcp_opt.c
    netinet/mptcp_timer.c
    netinet6/ah_core.c
    netinet6/ah_input.c
    netinet6/ah_output.c
    netinet6/esp_core.c
    netinet6/esp_input.c
    netinet6/esp_output.c
    netinet6/esp_rijndael.c
    netinet6/esp_chachapoly.c
    netinet6/ipsec.c
    netinet6/dest6.c
    netinet6/frag6.c
    netinet6/icmp6.c
    netinet6/in6.c
    netinet6/in6_cga.c
    netinet6/in6_cksum.c
    netinet6/in6_gif.c
    netinet6/ip6_forward.c
    netinet6/in6_ifattach.c
    netinet6/ip6_input.c
    netinet6/ip6_output.c
    netinet6/in6_src.c
    netinet6/in6_mcast.c
    netinet6/in6_pcb.c
    netinet6/in6_proto.c
    netinet6/in6_rmx.c
    netinet6/mld6.c
    netinet6/nd6.c
    netinet6/nd6_nbr.c
    netinet6/nd6_prproxy.c
    netinet6/nd6_rtr.c
    netinet6/nd6_rti.c
    netinet6/nd6_send.c
    netinet6/raw_ip6.c
    netinet6/route6.c
    netinet6/scope6.c
    netinet6/udp6_output.c
    netinet6/udp6_usrreq.c
    netinet6/ip6_id.c
    net/sixxlowpan.c
    net/frame802154.c
    net/linkaddr.c
    netkey/key.c
    netkey/key_debug.c
    netkey/keysock.c
    netkey/keydb.c
    net/multi_layer_pkt_log.c
    crypto/entropy/diag_entropy_sysctl.c
    security/audit/audit.c
    security/audit/audit_arg.c
    security/audit/audit_bsd.c
    security/audit/audit_bsm.c
    security/audit/audit_bsm_errno.c
    security/audit/audit_bsm_fcntl.c
    security/audit/audit_bsm_domain.c
    security/audit/audit_bsm_klib.c
    security/audit/audit_bsm_socket_type.c
    security/audit/audit_bsm_token.c
    security/audit/audit_mac.c
    security/audit/audit_pipe.c
    security/audit/audit_session.c
    security/audit/audit_syscalls.c
    security/audit/audit_worker.c
    pthread/pthread_shims.c
    pthread/pthread_priority.c
    pthread/pthread_workqueue.c
    kern/bsd_init.c
    kern/kdebug.c
    kern/kern_acct.c
    kern/kern_aio.c
    kern/kern_authorization.c
    kern/kern_backtrace.c
    kern/kern_clock.c
    kern/kern_core.c
    kern/kern_credential.c
    kern/kern_cs.c
    kern/kern_csr.c
    kern/kern_symfile.c
    kern/kern_descrip.c
    kern/kern_guarded.c
    kern/kern_event.c
    kern/kern_control.c
    kern/kern_exec.c
    kern/kern_exit.c
    kern/kern_ktrace.c
    kern/kern_lockf.c
    kern/kern_fork.c
    kern/kern_asl.c
    kern/kern_malloc.c
    kern/kern_mman.c
    kern/kern_persona.c
    kern/kern_physio.c
    kern/kern_priv.c
    kern/kern_proc.c
    kern/kern_prot.c
    kern/kern_resource.c
    kern/kern_shutdown.c
    kern/kern_sig.c
    kern/kern_subr.c
    kern/kern_synch.c
    kern/kern_sysctl.c
    kern/kern_newsysctl.c
    kern/kern_memorystatus.c
    kern/kern_memorystatus_freeze.c
    kern/kern_memorystatus_notify.c
    kern/kern_mib.c
    kern/kpi_mbuf.c
    kern/kern_sfi.c
    kern/kern_time.c
    kern/kern_xxx.c
    kern/mach_process.c
    kern/mcache.c
    kern/stackshot.c
    kern/subr_log.c
    kern/subr_prf.c
    kern/subr_sbuf.c
    kern/subr_xxx.c
    kern/sys_eventlink.c
    kern/sys_generic.c
    kern/sys_pipe.c
    kern/sys_socket.c
    kern/sys_domain.c
    kern/sys_coalition.c
    kern/sys_persona.c
    kern/sys_ulock.c
    kern/sys_work_interval.c
    kern/tty.c
    kern/tty_compat.c
    kern/tty_conf.c
    kern/tty_dev.c
    kern/tty_ptmx.c
    kern/tty_pty.c
    kern/tty_subr.c
    kern/tty_tty.c
    kern/ubc_subr.c
    kern/uipc_domain.c
    kern/uipc_mbuf.c
    kern/uipc_mbuf2.c
    kern/uipc_proto.c
    kern/uipc_socket.c
    kern/uipc_socket2.c
    kern/uipc_syscalls.c
    kern/uipc_usrreq.c
    kern/vsock_domain.c
    kern/sysv_ipc.c
    kern/sysv_shm.c
    kern/sysv_sem.c
    kern/sysv_msg.c
    kern/mach_fat.c
    kern/mach_loader.c
    kern/posix_sem.c
    kern/posix_shm.c
    kern/qsort.c
    kern/kpi_socket.c
    kern/kpi_socketfilter.c
    kern/proc_info.c
    kern/process_policy.c
    kern/kern_overrides.c
    kern/socket_info.c
    kern/subr_eventhandler.c
    kern/sys_reason.c
    vm/vnode_pager.c
    vm/vm_unix.c
    vm/dp_backing_file.c
    vm/vm_compressor_backing_file.c
    kern/kern_ntptime.c
    uxkern/ux_exception.c
    conf/param.c
    kern/imageboot.c
    kern/chunklist.c
    ../osfmk/kperf/kperfbsd.c
    kern/kern_kpc.c
    kern/proc_uuid_policy.c
    pgo/profile_runtime.c
    pgo/profile_runtime_data.c
    miscfs/nullfs/null_subr.c
    miscfs/nullfs/null_vfsops.c
    miscfs/nullfs/null_vnops.c
    miscfs/bindfs/bind_subr.c
    miscfs/bindfs/bind_vfsops.c
    miscfs/bindfs/bind_vnops.c
    net/skywalk_stubs.c
    dev/i386/conf.c
    dev/i386/cons.c
    dev/i386/km.c
    dev/i386/kern_machdep.c
    dev/i386/stubs.c
    dev/i386/systemcalls.c
    dev/i386/sysctl.c
    dev/i386/unix_signal.c
    dev/i386/dtrace_isa.c
    dev/i386/dtrace_subr_x86.c
    dev/i386/fbt_x86.c
    dev/i386/sdt_x86.c
    dev/i386/fasttrap_isa.c
    dev/i386/instr_size.c
    dev/i386/dis_tables.c
    kern/policy_check.c
    kern/bsd_stubs.c

    $<TARGET_OBJECTS:xnu.bsd_conf>
)
target_link_libraries(xnu.bsd_module PRIVATE xnu.ptrauth xnu.extheaders xnu.bsd_conf)
target_include_directories(xnu.bsd_module PRIVATE ${CMAKE_CURRENT_BINARY_DIR} ${CMAKE_CURRENT_SOURCE_DIR})
target_include_directories(xnu.bsd_module PRIVATE ${XNU_SOURCE_DIR}/iokit ${XNU_SOURCE_DIR}/libkern ${XNU_SOURCE_DIR}/osfmk ${XNU_SOURCE_DIR}/osfmk/libsa ${XNU_SOURCE_DIR}/pexpert ${XNU_SOURCE_DIR})
target_compile_definitions(xnu.bsd_module PRIVATE APPLE KERNEL KERNEL_BUILD KERNEL_PRIVATE BSD_KERNEL_PRIVATE XNU_KERNEL_PRIVATE __MACHO__=1 volatile=__volatile XNU_KERN_EVENT_DATA_IS_VLA XNU_TARGET_OS_OSX PLATFORM_MacOSX)
target_compile_options(xnu.bsd_module PRIVATE -mmacosx-version-min=11.0 -URC_ENABLE_XNU_PRODUCT_INFO_FILTER -DPRIVATE)
target_compile_options(xnu.bsd_module PRIVATE
    # From bsd/conf/Makefile.template
    -Wno-address-of-packed-member -Wno-cast-align -Wno-cast-qual -Wno-format -Wno-format-extra-args
    -Wno-format-invalid-specifier -Wno-implicit-int-conversion -Wno-shorten-64-to-32 -Wno-sign-compare
    -Wno-sign-conversion -Wno-incompatible-library-redeclaration
)
add_dependencies(xnu.bsd_module xnu.bsd_conf)
